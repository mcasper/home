#!/bin/bash

set -eou pipefail

bin/release

TAG=$(git rev-parse HEAD)
SERVER_IP=68.183.251.146

scp docker-compose-prod.yml root@68.183.251.146:docker-compose.yml
ssh root@$SERVER_IP TAG=$TAG docker-compose up --force-recreate --remove-orphans -d

sleep 5

ssh root@$SERVER_IP TAG=$TAG docker-compose run recipes bundle exec rails db:create db:migrate
ssh root@$SERVER_IP TAG=$TAG docker-compose run budget mix do ecto.create, ecto.migrate
